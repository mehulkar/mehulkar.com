#!/usr/bin/env bash

function log() {
    GREEN='\033[0;32m'
    NC='\033[0m'
    echo -e "${GREEN}[$PWD] ----- $1 -----${NC}"
}

git checkout source
GIT_REMOTE=$(git config --get remote.origin.url)
CURRENT_REV=$(git rev-parse --short HEAD)

TMP_GIT_DIR="tmp"
log "Create $TMP_GIT_DIR directory and move into it"
mkdir -p $TMP_GIT_DIR && cd $TMP_GIT_DIR
log "Create new git repo in $TMP_GIT_DIR directory"
git init
log "configure name and email"
git config --local user.email 'mehul.kar@gmail.com'
git config --local user.name 'Mehul Kar'
log "Add $GIT_REMOTE as 'origin' remote"
git remote add origin $GIT_REMOTE
log "Fetch latest from $GIT_REMOTE"
git fetch origin
log "Set new repo to latest origin/master"
git reset --hard origin/master

cd ..

log "Build middleman static files"
bundle exec middleman build

log "Moving new git repo into build dir"
mv $TMP_GIT_DIR/.git build/
rm -rf $TMP_GIT_DIR

cd build

log "Add and commit all the files"
git add -A
git commit -m "Publishing site at $CURRENT_REV"

log "push all the new things to origin/master"
git push origin HEAD:master

log "back to main folder and delete build directory"
cd ..
rm -rf build/

log "fetch all the latest"
git fetch --all