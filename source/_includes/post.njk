---
layout: layout.njk
---

<div class='post bb b--black-10 mb2'>
  <article class='mb3 mw7 center'>
    <header class='bb b--black-10 mv3'>
      <h3 class='f5 fw2 mb1'>{{page.date | fullDate }}</h2>
      <h1 class='fw3 mb2 mt0 post--title'>{{title}}</h1>

      {% for tag in (tags | splitTags)  %}
        {{tag | tagLink | safe }}
      {% endfor %}
    </header>

    {{content | safe }}
  </article>

  <p class='f6 bg-light-yellow pa3 black-80 br2 ba b--yellow mw7 center'>
    Want to talk about this post? <a class='black-80 underline' href='mailto:mehul.kar@gmail.com?subject=I have an opinion!'>
    Email me</a> or send me a toot <a class='black-80 underline' href="{{page | buildTweetURL(tags)}}" target='_blank'> @mehulkar</a>.
  </p>
</div>

<aside id="webmentions" class="webmentions mb3 mw7 center">
  <section id="wm-likes" class="wm-likes wm-hidden">
    <h2>Likes <span id="wm-like-count"></span></h2>
    <ul></ul>
  </section>

  <section id="wm-replies" class="wm-replies wm-hidden">
    <h2>Replies <span id="wm-reply-count"></span></h2>
    <ul></ul>
  </section>

  <template id="wm-like">
    <img alt="" id="wm-reply-author-photo" class="wm-reply-author-photo mr1" width="40" height="auto" src="">
  </template>

  <template id="wm-reply">
    <li>
      <div class="flex items-end mb2 bb pb2 b--black-10">
        <img alt="" id="wm-reply-author-photo" class="wm-reply-author-photo mr1" width="40" height="auto" src="">
        <span id="wm-reply-author" class="wm-reply-author"></span>
        <span id="wm-reply-date"></span>
      </div>
      <div id="wm-reply-text"></div>
      <span id="wm-reply-link" class="wm-reply-link"></span>
    </li>
  </template>
</aside>

<script>
    const postUrl = 'https://www.mehulkar.com{{page.url}}';

    if (postUrl) {
      // count
      fetch("https://webmention.io/api/count?target=" + postUrl)
      .then(response => response.json())
      .then((res) => {
        console.log('webmention counts', res);
        if (res.count > 0) {
          document.getElementById('wm-reply-count').innerText = `(${res.type.reply})`;
          document.getElementById('wm-like-count').innerText = `(${res.type.like})`;
        }
      });


      // mentions
      fetch("https://webmention.io/api/mentions.jf2?target=" + postUrl + "&sort-by=published&sort-dir=up")
      .then(response => response.json())
      .then(response => {
        const byType = new Map();
        response.children.forEach(child => {
          const type = child['wm-property']
          if (!byType.has(type)) {
            byType.set(type, [])
          }
          byType.get(type).push(child);
        })

        const fullDate = Intl.DateTimeFormat("en-us", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });

        console.log('byType', byType);

        const replies = byType.get('in-reply-to');
        if (replies && replies.length > 0) {
          const section = document.querySelector('#wm-replies');
          const listEl = section.querySelector('ul');
          const template = document.getElementById('wm-reply');

          replies.map(entry => {
            const ts = new Date(entry.published)
            const clone = template.content.cloneNode(true);
            clone.querySelector('#wm-reply-text').innerHTML = entry.content.html;
            clone.querySelector('#wm-reply-author-photo').setAttribute('src', entry.author.photo);
            clone.querySelector('#wm-reply-author-photo').setAttribute('alt', `${entry.author.name}`);
            clone.querySelector('#wm-reply-author').innerHTML = `<a href="${entry.author.url}">${entry.author.name}</a> said...`;
            clone.querySelector('#wm-reply-date').innerHTML = `<time>${fullDate.format(ts)}</time>`;
            clone.querySelector('#wm-reply-link').innerHTML = `<a target="_blank" href="${entry.url}">ðŸ”—</time>`;
            listEl.appendChild(clone);
          });

          section.classList.toggle('wm-hidden');
        }

        const likes = byType.get('like-of');
        if (likes && likes.length > 0){
          const section = document.querySelector('#wm-likes');
          const listEl = section.querySelector('ul');

          const template = document.getElementById('wm-like');
          likes.forEach(entry => {
            const clone = template.content.cloneNode(true);
            clone.querySelector('#wm-reply-author-photo').setAttribute('src', entry.author.photo);
            clone.querySelector('#wm-reply-author-photo').setAttribute('alt', `Liked by ${entry.author.name}`);
            listEl.appendChild(clone);
          });

          section.classList.toggle('wm-hidden');
        }
      });
    }
</script>
